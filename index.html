<!DOCTYPE html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="styles.css">
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="d3-tooltip.js"></script>
</head>
<body>
 <div id="container">
  <div id="chart">
   <div id="select-run">
    <div id="platforms" style="display: inline">
      <div class="select-item">
        <span>OS</span>
        <select id="platform"></select>
      </div>
      <div class="select-item">
        <span>Version</span>
        <select id="platform_version"></select>
      </div>
    </div>
    <div id="providers" style="display: inline">
      <div class="select-item">
        <span>Provider</span>
        <select id="provider"></select>
      </div>
      <div class="select-item">
        <span>Size</span>
        <select id="instance_size"></select>
      </div>
    </div>
    <div class="select-item">
      <span>Instance</span>
      <select id="run"></select>
    </div>
   </div>
   <div id="sidebar">
    <div id="top">
      <div class="item">
       <div class="circle"></div>
       <span class="name"></span>
       <div class="size">
         <span class="time"></span>
         <span>Seconds</span>
       </div>
       <div class="toggle"></div>
       <div class="extra"></div>
      </div>
    </div>

    <div id="children"></div>
   </div>
  </div>
 </div>

<script>
// Setup the select boxes - A lot of ugly magic happens here
d3.json("available-runs.json", function(error, data) {
  if (error) {
      alert(error.statusText + " " + error.status + " - available-runs.json");
      return console.warn(error);
    }

  function item(file) {
     return data['items'].filter(function(d, i) {
        return d.value === file;
     })[0]
  }

  var hash = loadHash()
  if (hash.file === null) {
    var dropdown = d3.selectAll('#run')
    var file = dropdown.node().options[0].__data__.value
    var platform_version = 'All'
    var platform = 'All'
    var provider = 'All'
    var instance_size = 'All'
  } else {
    // update the selected option
    var file = hash.file
    item = item(file)
    var platform_version = item.platform_version
    var platform = item.platform
    var provider = item.provider
    var instance_size = item.instance_size
  }

  // Set data in selects
  versions = ['All']
  if (platform_version !== 'All') {
    versions = versions.concat(data['platforms'][platform])
  }

  // When the platform changes update the platform Versions available
  var dropdown = updateSelect('platform', ['All'].concat(d3.keys(data['platforms'])), platform)
  dropdown.on('change', function() {
    name = d3.select(this).property('value')
    if (name == 'All') {
        updateSelect('platform_version', ['All'], 'All')
        updateFileSelect(data['items'])
        return;
    }

    // Filter platform versions
    updateSelect('platform_version', ['All'].concat(data['platforms'][name]))
    updateFileSelect(data['items'])
  })

  // Filter platform Version
  var dropdown = updateSelect('platform_version', versions, platform_version)
  dropdown.on('change', function() {
    version = d3.select(this).property('value')
    if (version == 'All') {
        updateFileSelect(data['items'])
        return;
    }

    // Filter Files
    updateFileSelect(data['items'])
  })

  // Update Provider
  var dropdown = updateSelect('provider', ['All'].concat(d3.keys(data['providers'])), provider)
  dropdown.on('change', function() {
    provider = d3.select(this).property('value')
    if (provider == 'All') {
        updateSelect('instance_size', ['All'], 'All')
        updateFileSelect(data['items'])
        return;
    }

    // Filter instance sice
    updateSelect('instance_size', ['All'].concat(data['providers'][provider]))
    updateFileSelect(data['items'])
  })

  // Set data in selects
  sizes = ['All']
  if (provider !== 'All') {
    sizes = sizes.concat(data['providers'][provider])
  }

  // Update Instance Size
  var dropdown = updateSelect('instance_size', sizes, instance_size)
  dropdown.on('change', function() {
    size = d3.select(this).property('value')
    if (size == 'All') {
        updateFileSelect(data['items'])
        return;
    }

    updateFileSelect(data['items'])
  })

  // Parse hash information
  updateFileSelect(data['items']).on('change', function() {
    var file = d3.select(this).property('value')
    draw(file)

    // Force top level path when changing files
    setHash(0, file)
  })

  // Draw graph based on the selected data file
  draw(file)
})

function updateSelect(selector, items, default_value) {
  var dropdown = d3.select('#' + selector)
  dropdown.selectAll("option").remove()
  var options = dropdown.selectAll("option").data(items)

   options
     .enter()
      .append("option")
      .attr("value", function(d){ return d; })
      .text(function(d){ return d; });

   options.exit().remove()
   if (typeof default_value !== 'undefined') {
     dropdown.property("value", default_value).node().focus()
   }

   return dropdown;
}

// Prime the File selector
function updateFileSelect(items, default_value) {
  // Filter Data
  var filters = [
   'platform',
   'platform_version',
   'provider',
   'instance_size'
  ]
  items = items.filter(function(d, i) {
    var keep = true
    filters.forEach(function (element) {
      value = d3.select('#' + element).property("value")
      if (value === 'All') {
        return;
      }

      if (d[element] !== value) {
        keep = false
      }
    })

    return keep;
  })

  var dropdown = d3.selectAll('#run')
  dropdown.selectAll("option").remove()
  var options = dropdown
              .selectAll("option")
              .data(items.sort(function(a, b) { return d3.descending(a.value, b.value); }))

  options
    .enter()
      .append("option")
      .attr("value", function(d){ return d.value; })
      .text(function(d){ return d.text; });

  options.exit().remove()
  if (typeof default_value !== 'undefined') {
    dropdown.property("value", default_value).node().focus()
  }

  return dropdown;
}

/* Setup defaults for the chart */
var width = 660,
    height = 700,
    radius = Math.min(width, height) / 2,
    x = d3.scale.linear().range([0, 2 * Math.PI]),
    y = d3.scale.pow().exponent(1.3).domain([0, 1]).range([0, radius]),
    color = d3.scale.category10();
    padding = 5

var div = d3.select("#chart")
var svg = div.append("svg")
  .attr("width", width + padding * 2)
  .attr("height", height + padding * 2)
.append("g")
  .attr("transform", "translate(" + [radius + padding, radius + padding] + ")")
   .on('mouseleave', function() {
        // When a user moves outside the main container we revert the sidebar
        load()
    })

var partition = d3.layout.partition()
    .sort(function(a, b) { return d3.ascending(a.value, b.value); })
    .value(function(d) { return d.size; });

var arc = d3.svg.arc()
    .startAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x))); })
    .endAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx))); })
    .innerRadius(function(d) { return Math.max(0, d.y ? y(d.y) : d.y); })
    .outerRadius(function(d) { return Math.max(0, y(d.y + d.dy)); });


function draw(file) {
  d3.json(file + '.json', function(error, data) {
    if (error) {
      alert(error.statusText + " " + error.status + " - " + file + ".json");
      return console.warn(error);
    }

    // FIXME remove this when we figure out to update properly
    svg.selectAll('path').remove()
    var path = svg.datum(data).selectAll("path").data(partition.nodes)

    path.enter()
    .append("path")
      .each(function (d, i) {
        // Make sure the path id is in the object
        d.id = i
      })
      .attr("id", function(d, i) { return "path-" + i; })
      .attr("d", arc)
      .style("fill", function(d) {
        // Use name and id as many names can be identical
        node = (d.children ? d : d.parent)
        return color(node.name + node.id);
      })
      .style("cursor", function(d) { return !d.children ? null : "pointer"; })
      .on("mouseover", mouseover)
      .on('mouseout', mouseout)
      .on('click', click);

      path.exit().remove()

      // Depends on the path variable
      function click(d) {
        updateSidebar(d)

        // Make sure the file name is still set
        hash = loadHash()
        setHash(d.id, hash.file)

        // No point in clicking into a childrenless node
        if (!d.children) {
          return;
        }

        path
          .transition()
          .duration(750)
          .attrTween("d", arcTween(d));

        // Use name and id as many names can be identical
        if (d.depth > 0) {
            path.style("fill", function(d) { return color(d.name + d.id); })
        } else{
            path.style("fill", function(d) {
              node = (d.children ? d : d.parent)
              return color(node.name + node.id);
            })
        }
      }

      function mouseover(d) {
        updateSidebar(d)
        tooltip_text = '<div>'+d.name+'</div>  <div>'+d3.round(d.value, 3)+' secs</div>';
        tooltip.show([d3.event.clientX,d3.event.clientY], tooltip_text)
        setPulsate(d.id)
      }

      function mouseout(d) {
        tooltip.cleanup()
        clearPulsate(d.id)
      }

      // Set the initial node
      load()
    });
}

// Interpolate the scales!
function arcTween(d) {
  var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
      yd = d3.interpolate(y.domain(), [d.y, 1]),
      yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
  return function(d, i) {
    return i
        ? function(t) { return arc(d); }
        : function(t) { x.domain(xd(t)); y.domain(yd(t)).range(yr(t)); return arc(d); };
  };
}

// Graph event code
function load() {
  var hash = loadHash()
  updateSidebar(d3.select('#path-' + hash.id).datum())
  fakeClick(hash.id)
}

function pulsate(node, original) {
    var color = d3.rgb(original)
    node
      .transition()
      .duration(700)
      .style('fill', color.darker(0.5))
      .transition()
      .duration(300)
      .style('fill', original)
}

function setPulsate(context) {
  if (typeof pulsateInterval !== 'undefined') {
    clearInterval(pulsateInterval)
    pulsateInterval = 0
  }

  var id = context
  if (typeof context === 'object') {
    var id = d3.select(context).attr('id')
  }

  var node = d3.select('#path-' + id)
  original = node.style('fill')
  pulsateInterval = setInterval(function(){ pulsate(node, original) } , 1000);
}

function clearPulsate(context) {
  var id = context
  if (typeof context === 'object') {
    var id = d3.select(context).attr('id')
  }

  // Fix the color back
  d3.select('#path-' + id).style('fill', original)

  if (typeof pulsateInterval !== 'undefined') {
    clearInterval(pulsateInterval)
    pulsateInterval = 0
  }
}

function loadHash() {
  var id = 0,
      file = null
  var hash = location.hash.substring(1);
  if (hash != "") {
    // Check for filename
    if (hash.match('/')) {
      var split = hash.split('/', 2)
      var file = split[0],
          id = parseInt(split[1])
    } else {
      var id = parseInt(hash)
    }
  }

  return {'id': id, 'file': file}
}

function setHash(id, file) {
    var output = id
    if (file !== null) {
      var output = file + '/' + id
    }

    location.hash = output
}

function fakeClick(id) {
    // Fake click the element. Could be replaced with jquery trigger()
    var event = document.createEvent("SVGEvents");
    event.initEvent("click",true,true);
    d3.select('#path-' + id).node().dispatchEvent(event);

    // Make sure the file name is still set
    setHash(id, loadHash().file)
}

function updateSidebar(d) {
    // Cleanup sidebar
    d3.select('#children').selectAll('div').remove()

    var node = d3.select('#path-' + d.id)
    d3.select('#top .item .circle').style('background-color', node.style('fill'))
    d3.select('#top .item .name').text(d.name)
    d3.select('#top .item .time').text(d3.round(d.value, 3))
    d3.select('#top .item .toggle').text('')
    // Setup instance information
    var extra = d3.select('#top .item .extra')
    extra.text('')

    // Show / hide instance info
    if (typeof d.instance !== 'undefined' && typeof d.env !== 'undefined') {
      var div = d3.select('#top .item .toggle')
      div.text('Toggle Instance Information').on('click', function() {
       swap = (extra.style('display') === 'block' ? 'none' : 'block')
       extra.style('display', swap)
      })
    }

    if (typeof d.instance !== 'undefined') {
      extra.append('p').text('Instance')
      extra.append('div').html('<strong>Start Time:</strong>&nbsp;' + d['start_time'])
      extra.append('div').html('<strong>Hplatformtname:</strong>&nbsp;' + d.instance['hplatformtname'])
      extra.append('div').html('<strong>Role:</strong>&nbsp;' + d.instance['instance_role'])
      extra.append('div').html('<strong>Provider:</strong>&nbsp;' + d.instance['provider'])
      if (d.instance['provider'] === 'ec2'){
        extra.append('div').html('<strong>Location:</strong>:&nbsp;' + d.instance['location'])
        extra.append('div').html('<strong>Size:</strong>&nbsp;' + d.instance['instance_size'])
        extra.append('div').html('<strong>Image:</strong>&nbsp;' + d.instance['image_id'])
      }
    }

    if (typeof d.env !== 'undefined') {
      extra.append('p').text('Environment')
      extra.append('div').html('<strong>Owner:</strong>&nbsp;' + d.env['email'])
      extra.append('div').html('<strong>Env Name:</strong>&nbsp;' + d.env['name'])
      extra.append('div').html('<strong>Stack:</strong>&nbsp;' + d.env['stack'])
    }
    

    // If no children then stop seeking
    if (!d.children) {
      // Build up info about the node
      var extra = d3.select('.extra')
      if (d.instance_vars.command) {
        extra.append('div').html('<strong>Command:</strong><br/>' + d.instance_vars.command)
      }

      if (d.instance_vars.code) {
        extra.append('div').html('<strong>Code:</strong><br/>' + d.instance_vars.code)
      }

      if (d.instance_vars.source) {
        extra.append('div').html('<strong>Source:</strong><br/>' + d.instance_vars.source)
      }

      if (d.instance_vars.source_line) {
        extra.append('div').html('<strong>Source Line:</strong><br/>' + d.instance_vars.source_line)
      }

      if (
        d.instance_vars.resource_name === 'package' ||
        d.instance_vars.resource_name === 'gem_package'
      ) {
        if (typeof d.instance_vars.action === 'array') {
            action = d.instance_vars.action[0]
        } else {
            action = d.instance_vars.action
        }

        type = ''
        if (d.instance_vars.resource_name === 'gem_package') {
            type = 'Gem '
        }

        extra.append('div').html('<strong>' + type + 'Package ' + action + ':</strong><br/>' + d.instance_vars.package_name + ' - v' + d.instance_vars.version)
      }

      return;
    }

    // Sort based on size (time)
    children = d.children
    children.sort(function(a, b) { return d3.ascending(a.value, b.value); })

    children_div = d3.select('#children')
    for (var i = children.length - 1; i >= 0; i -= 1) {
        child = children[i]
        node = d3.select('#path-' + child.id)

        div = children_div.append('div')
        div.classed('item', 'item')
        div.attr('id', child.id)
        div.append('div').classed('circle', 'circle').style('background-color', node.style('fill'))
        div.append('span').classed('name', 'name').text(child.name)
        div.on('click', function(d) {
            id = d3.select(this).attr('id')
            fakeClick(id)
        })
        div.on('mouseover', function() {
            setPulsate(this)
        })
        div.on('mouseout', function() {
          clearPulsate(this)
        })

        time = div.append('div').classed('size', 'size')
        time.append('span').classed('time', 'time').text(d3.round(child.value, 3))
        time.append('span').text('Seconds')
    }

}

</script>
</body>
</html>
